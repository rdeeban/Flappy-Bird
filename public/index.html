<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon">
    <style>
        canvas {
            border-radius: 5px;
        }
    </style>
</head>
<body onload="main()">
<script>
    let myGame;
    let myTitleScreenSet;
    let myGameScreenSet;
    let myBird;
    let myPipes;
    let myFrameNo;
    let myScreen;
    let myCanvas;
    const CANVAS_HEIGHT = 512;
    const CANVAS_WIDTH = 288;
    const SCREEN_TITLE_SCREEN = "titleScreen";
    const SCREEN_GAME_SCREEN = "gameScreen";
    const FACING_DIRECTION_UP = "up";
    const FACING_DIRECTION_DOWN = "down";

    function main() {
        myGame = new Game();
        myGame.start();
    }

    function Game() {
        this.start = function() {
            myCanvas = document.createElement("canvas");
            myCanvas.height = CANVAS_HEIGHT;
            myCanvas.width = CANVAS_WIDTH;
            document.body.insertBefore(myCanvas, document.body.childNodes[0]);
            myTitleScreenSet = new TitleScreen();
            myGameScreenSet = new GameScreen();
            myBird = new Bird(69, 253, 24.5, 40);
            myPipes = [];
            myFrameNo = 0;
            myScreen = SCREEN_TITLE_SCREEN;
            myCanvas.addEventListener('mousedown', function (_) {
                if (myScreen === SCREEN_TITLE_SCREEN) {
                    myScreen = SCREEN_GAME_SCREEN;
                }
            });

            setInterval(this.update, 20);
        };

        this.update = function() {
            this.clear();
            myFrameNo++;
            if (myScreen === "titleScreen") {
                myTitleScreenSet.update();
                myBird.update(myFrameNo);
            } else if (myScreen === "gameScreen") {
                myGameScreenSet.update();
                myBird.update(myFrameNo);
            } else {
                throw new Error("The value of myScreen is not recognized.");
            }
        }.bind(this);

        this.clear = function() {
            myCanvas.getContext('2d').clearRect(0, 0, myCanvas.width, myCanvas.height);
        }
    }

    function TitleScreen() {
        let backgroundDayImage = new Image();
        backgroundDayImage.src = "/resources/background-day.png";
        let messageImage = new Image();
        messageImage.src = "/resources/message.png";
        let baseImage = new Image();
        baseImage.src = "/resources/base.png";

        this.update = function() {
            let context = myCanvas.getContext('2d');
            context.drawImage(backgroundDayImage, 0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
            context.drawImage(messageImage, 45, 75, CANVAS_WIDTH * 0.7, CANVAS_HEIGHT * 0.55);
            context.drawImage(baseImage, 0, 400, CANVAS_WIDTH, CANVAS_HEIGHT * 0.3);
        }
    }

    function GameScreen() {
        let backgroundDayImage = new Image();
        backgroundDayImage.src = "/resources/background-day.png";
        let backgroundNightImage = new Image();
        backgroundNightImage.src = "/resources/background-night.png";
        let baseImage = new Image();
        baseImage.src = "/resources/base.png";

        function isDayTime() {
            const now = new Date();
            const currentHour = now.getHours();
            return currentHour >= 6 && currentHour < 18;
        }

        const isDay = isDayTime();
        let digitFileNames = [
            "0.png",
            "1.png",
            "2.png",
            "3.png",
            "4.png",
            "5.png",
            "6.png",
            "7.png",
            "8.png",
            "9.png"
        ];

        let digitImages = [];
        for (let i = 0; i < digitFileNames.length; i++) {
            let digitImage = new Image();
            digitImage.src = "/resources/" + digitFileNames[i];
            digitImages.push(digitImage);
        }

        function prepend(value, array) {
            let newArray = array.slice();
            newArray.unshift(value);
            return newArray;
        }

        function getDigits(frameNo) {
            let currentFrameNo = frameNo;
            let digits = [];
            while (currentFrameNo > 0) {
                digits = prepend(currentFrameNo % 10, digits);
                currentFrameNo = Math.floor(currentFrameNo / 10);
            }

            return digits;
        }

        this.numPipesPassed = 0;
        this.update = function() {
            let context = myCanvas.getContext('2d');
            context.drawImage(isDay ? backgroundDayImage : backgroundNightImage, 0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
            context.drawImage(baseImage, 0, 400, CANVAS_WIDTH, CANVAS_HEIGHT * 0.3);
            let digits = getDigits(this.numPipesPassed);
            for (let i = digits.length - 1; i > -1; i--) {
                let digit = digits[i];
                context.drawImage(digitImages[digit], 89 + i*40, 10, 35, 35);
            }
        }
    }

    function Bird(x, y, height, width) {
        this.x = x;
        this.y = y;
        this.height = height;
        this.width = width;
        const birdImageFileNames = [
            "yellowbird-downflap.png",
            "yellowbird-midflap.png",
            "yellowbird-upflap.png",
            "yellowbird-midflap.png"
        ];

        let birdImages = [];
        for (let i = 0; i < birdImageFileNames.length; i++) {
            let birdImage = new Image();
            birdImage.src = "/resources/" + birdImageFileNames[i];
            birdImages.push(birdImage);
        }

        this.update = function(frameNo) {
            myCanvas.getContext('2d').drawImage(birdImages[Math.floor((frameNo / 4.5) % 4)], this.x, this.y, this.width, this.height);
        }
    }

    function Pipe(facingDirection, x, y, height, width) {
        this.image = new Image();
        if (facingDirection === FACING_DIRECTION_UP) {
            this.image.src = "/resources/pipe-green-u.png";
        }
        else if (facingDirection === FACING_DIRECTION_DOWN) {
            this.image.src = "/resources/pipe-green-d.png";
        } else {
            throw new Error("The value of facingDirection is not recognized.");
        }

        this.height = height;
        this.width = width;
        this.x = x;
        this.y = y;
        this.update = function() {
            let context = myCanvas.getContext('2d');
            context.drawImage(this.image,
                this.x,
                this.y,
                this.width, this.height);
        }
    }
</script>
<br>
</body>
</html>
